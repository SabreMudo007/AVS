<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="Imagens/AVS-logo.png">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="Estilos.css">
<title>AVS - Conta</title>
</head>

<body class="body-doar">

<nav>
  <ul class="list-menu">
    <li><a href="Home.html"><img src="Imagens/AVS-logo.png" alt="AVS" height="5px" width="5px"></a></li>
    <li><a href="Home.html">Inicio</a></li>
    <li><a href="Eventos.html">Eventos</a></li>
    <li><a href="Doar.html">Doar</a></li>
    <li><a href="Sobre.html">Sobre nós</a></li>
    <li><a href="Join.html">Junte-se às equipas</a></li>
    <li>Conta</li>
  </ul>
</nav>

<section class="login-container">
  <div class="login-card">
    <h2>Bem-vindo à sua conta!</h2>
    <p>Aqui você pode ver informações da sua conta e gerir suas ações.</p>

    <h3>Histórico de Doações</h3>
    <p>Aqui verás o teu histórico de doações ao AVS.</p>

    <div class="tabela-container">
      <table class="tabela-doacoes">
        <thead>
          <tr>
            <th>Data</th>
            <th>Valor (€)</th>
            <th>Mensagem</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="tabelaDoacoes">
          <!-- Linhas inseridas pelo JavaScript -->
        </tbody>
      </table>
    </div>

    <button id="logoutBtn" class="logout-button">Terminar Sessão</button>
  </div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBIE36QlivTvwqx6fjEV2EVAK2gN7dRdrs",
  authDomain: "avs-login-b3345.firebaseapp.com",
  projectId: "avs-login-b3345",
  storageBucket: "avs-login-b3345.firebasestorage.app",
  messagingSenderId: "441342978542",
  appId: "1:441342978542:web:884bc7280c4db0c6bdc6ff"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const tabela = document.getElementById("tabelaDoacoes");

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "Conta.html"; // Redireciona para a página de login se não estiver autenticado
    return; // interrompe a execução do restante código
  }

  try {
    // cria uma consulta para obter as doações do utilizador
    const q = query(collection(db, "doacoes"), where("uid", "==", user.uid)); // vai buscar à coleção "doacoes" onde o campo "uid" é igual ao UID do utilizador
    const snapshot = await getDocs(q); // executa a consulta e obtém os documentos correspondentes

    if (snapshot.empty) { // se não houver doações
      tabela.innerHTML = `<tr><td colspan="4">Ainda não realizou doações</td></tr>`;
      return; // interrompe a execução do restante código
    }

    const doacoes = snapshot.docs // processa os documentos obtidos
      .map(doc => ({ id: doc.id, ...doc.data() })) // mapeia cada documento para um objeto com o ID e os dados
      .sort((a, b) => { // ordena as doações por data, da mais recente para a mais antiga
        const timeA = a.data ? a.data.toMillis() : 0; // converte a data para milissegundos
        const timeB = b.data ? b.data.toMillis() : 0; // converte a data para milissegundos
        return timeB - timeA; // ordena em ordem decrescente
      });

    doacoes.forEach(d => { // para cada doação
      const dataStr = d.data ? d.data.toDate().toLocaleDateString("pt-PT") : "—"; // formata a data para o formato português ou usa "—" se não houver data
      tabela.innerHTML += ` 
        <tr>
          <td>${dataStr}</td>
          <td>${d.valor.toFixed(2)} €</td>
          <td>${d.mensagem}</td>
          <td>${d.estado}</td>
        </tr>
      `;
    }); // adiciona uma linha na tabela para cada doação

  } catch (error) { // em caso de erro ao obter as doações
    console.error("Erro ao carregar histórico:", error); 
    tabela.innerHTML = `<tr><td colspan="4">Erro ao carregar histórico</td></tr>`;
  }
});

document.getElementById("logoutBtn").addEventListener("click", () => {
  signOut(auth).then(() => {
    alert("Sessão encerrada com sucesso!");
    window.location.href = "Home.html";
  });
});
</script>

</body>
</html>



