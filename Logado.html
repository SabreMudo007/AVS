<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AVS - Conta</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="Estilos.css">
</head>

<body class="body-doar">

<nav>
  <ul class="list-menu">
    <li><img src="AVS-logo.png" alt="Logo AVS" height="5px" width="5px"></li>
    <li><a href="Home.html">Inicio</a></li>
    <li><a href="Eventos.html">Eventos</a></li>
    <li><a href="Doar.html">Doar</a></li>
    <li><a href="Sobre.html">Sobre nós</a></li>
    <li><a href="Join.html">Junte-se às equipas</a></li>
    <li>Conta</li>
  </ul>
</nav>

<section class="login-container">
  <div class="login-card">
    <h2>Bem-vindo à sua conta!</h2>
    <p>Aqui você pode ver informações da sua conta e gerir suas ações.</p>

    <h3>Histórico de Doações</h3>
    <p>Aqui verás o teu histórico de doações ao AVS.</p>

    <div class="tabela-container">
      <table class="tabela-doacoes">
        <thead>
          <tr>
            <th>Data</th>
            <th>Valor (€)</th>
            <th>Mensagem</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="tabelaDoacoes">
          <!-- Linhas inseridas pelo JavaScript -->
        </tbody>
      </table>
    </div>

    <button id="logoutBtn" class="logout-button">Terminar Sessão</button>
  </div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBIE36QlivTvwqx6fjEV2EVAK2gN7dRdrs",
  authDomain: "avs-login-b3345.firebaseapp.com",
  projectId: "avs-login-b3345",
  storageBucket: "avs-login-b3345.firebasestorage.app",
  messagingSenderId: "441342978542",
  appId: "1:441342978542:web:884bc7280c4db0c6bdc6ff"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const tabela = document.getElementById("tabelaDoacoes");

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "Conta.html";
    return;
  }

  try {
    // Consulta sem orderBy para evitar problemas com documentos sem timestamp
    const q = query(collection(db, "doacoes"), where("uid", "==", user.uid));
    const snapshot = await getDocs(q);

    if (snapshot.empty) {
      tabela.innerHTML = `<tr><td colspan="4">Ainda não realizou doações</td></tr>`;
      return;
    }

    // Ordenar manualmente pelo campo data (se existir)
    const doacoes = snapshot.docs
      .map(doc => ({ id: doc.id, ...doc.data() }))
      .sort((a, b) => {
        const timeA = a.data ? a.data.toMillis() : 0;
        const timeB = b.data ? b.data.toMillis() : 0;
        return timeB - timeA; // descendente
      });

    // Preencher a tabela
    doacoes.forEach(d => {
      const dataStr = d.data ? d.data.toDate().toLocaleDateString("pt-PT") : "—";
      tabela.innerHTML += `
        <tr>
          <td>${dataStr}</td>
          <td>${d.valor.toFixed(2)} €</td>
          <td>${d.mensagem}</td>
          <td>${d.estado}</td>
        </tr>
      `;
    });

  } catch (error) {
    console.error("Erro ao carregar histórico:", error);
    tabela.innerHTML = `<tr><td colspan="4">Erro ao carregar histórico</td></tr>`;
  }
});

document.getElementById("logoutBtn").addEventListener("click", () => {
  signOut(auth).then(() => {
    alert("Sessão encerrada com sucesso!");
    window.location.href = "Home.html";
  });
});
</script>

</body>
</html>



